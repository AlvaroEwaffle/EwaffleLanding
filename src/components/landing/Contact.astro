<section id="contact" class="py-20 bg-white relative overflow-hidden">
  <div class="container mx-auto px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Section Header -->
      <div class="text-center mb-12">
        <h2 class="text-4xl md:text-5xl font-bold text-primary mb-4">
          Conversemos sobre tu proyecto
        </h2>
        <p class="text-xl text-gray-600">
          Cuéntanos sobre tus necesidades de capacitación y te ayudaremos a crear la mejor solución e-learning para tu organización.
        </p>
      </div>

      <!-- Contact Form -->
      <div class="bg-white rounded-2xl shadow-xl p-8 md:p-12">
        <form 
          class="space-y-6"
          id="contact-form"
        >
          <!-- Name Fields -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
                Nombre *
              </label>
              <input
                type="text"
                name="firstName"
                id="firstName"
                required
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition duration-200"
                placeholder="Tu nombre"
              />
            </div>
            <div>
              <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
                Apellido *
              </label>
              <input
                type="text"
                name="lastName"
                id="lastName"
                required
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition duration-200"
                placeholder="Tu apellido"
              />
            </div>
          </div>

          <!-- Contact Info -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                Email corporativo *
              </label>
              <input
                type="email"
                name="email"
                id="email"
                required
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition duration-200"
                placeholder="tu@empresa.com"
              />
            </div>
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                Teléfono
              </label>
              <input
                type="tel"
                name="phone"
                id="phone"
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition duration-200"
                placeholder="+56 9 1234 5678"
              />
            </div>
          </div>

          <!-- Company Info -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="company" class="block text-sm font-medium text-gray-700 mb-1">
                Empresa *
              </label>
              <input
                type="text"
                name="company"
                id="company"
                required
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition duration-200"
                placeholder="Nombre de tu empresa"
              />
            </div>
            <div>
              <label for="role" class="block text-sm font-medium text-gray-700 mb-1">
                Cargo *
              </label>
              <input
                type="text"
                name="role"
                id="role"
                required
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition duration-200"
                placeholder="Tu cargo en la empresa"
              />
            </div>
          </div>

          <!-- Services Interest -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Servicios de interés *
            </label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="cursos_gamificados" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Cursos Gamificados SCORM</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="plataforma_lms" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Plataforma LMS</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="chatbots_ia" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Chatbots IA / Asistentes IA</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="gamificacion" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Gamificación Avanzada</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="produccion_multimedia" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Producción Multimedia</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="certificaciones" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Certificaciones Digitales</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="diseño_instruccional" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Diseño Instruccional</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="soluciones_empresariales" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Soluciones Empresariales</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services[]" value="curso_ia_elearning" class="text-primary rounded focus:ring-primary" />
                <span class="text-gray-700">Curso en Vivo: IA para E-learning</span>
              </label>
            </div>
          </div>

          <!-- Message -->
          <div>
            <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
              Mensaje *
            </label>
            <textarea
              name="message"
              id="message"
              required
              rows="4"
              class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition duration-200"
              placeholder="Cuéntanos sobre tu proyecto o necesidades de capacitación..."
            ></textarea>
          </div>

          <!-- reCAPTCHA -->
          <div class="flex justify-center">
            <div id="recaptcha-container" class="g-recaptcha" data-sitekey="6LdreEosAAAAAO41BIpcr_nzGac9Bz4vdv3ZoKs4"></div>
          </div>

          <!-- Submit Button -->
          <div class="flex justify-center">
            <button
              type="submit"
              id="submit-button"
              class="inline-flex items-center justify-center px-8 py-4 bg-primary text-white rounded-full font-semibold text-lg hover:bg-primary/90 transition-colors duration-300 shadow-lg hover:shadow-xl"
            >
              <span>Enviar mensaje</span>
              <i class="ri-send-plane-line ml-2"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- reCAPTCHA v2 Script -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
  // Initialize EmailJS
  (function() {
    emailjs.init("K-nZvIRLeVaUXubMu"); // Replace with your EmailJS public key
  })();

  // Helper function to get reCAPTCHA response
  function getRecaptchaResponse() {
    return new Promise((resolve, reject) => {
      // Wait for reCAPTCHA to be ready
      if (typeof grecaptcha === 'undefined') {
        reject(new Error('reCAPTCHA no está cargado'));
        return;
      }

      const recaptchaResponse = grecaptcha.getResponse();
      if (!recaptchaResponse) {
        reject(new Error('Por favor, completa el reCAPTCHA'));
        return;
      }

      resolve(recaptchaResponse);
    });
  }

  // Form submission handler
  const form = document.getElementById('contact-form');
  const submitButton = document.getElementById('submit-button');
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!form || !submitButton) return;

    // Validate reCAPTCHA first
    let recaptchaToken;
    try {
      recaptchaToken = await getRecaptchaResponse();
    } catch (error) {
      alert(error.message || 'Por favor, completa el reCAPTCHA para continuar.');
      return;
    }

    // Disable submit button and show loading state
    const buttonText = submitButton.querySelector('span');
    const buttonIcon = submitButton.querySelector('i');
    const originalText = buttonText.textContent;
    submitButton.disabled = true;
    buttonText.textContent = 'Enviando...';
    buttonIcon.className = 'ri-loader-4-line ml-2 animate-spin';
    
    try {
      // Get form data
      const firstName = form.firstName.value;
      const lastName = form.lastName.value;
      const email = form.email.value;
      const phone = form.phone.value || '';
      const name = `${firstName} ${lastName}`.trim();
      
      // Get selected services
      const selectedServices = Array.from(form.querySelectorAll('input[name="services[]"]:checked'))
        .map(checkbox => checkbox.value)
        .join(', ');

      // Prepare template parameters for EmailJS
      const templateParams = {
        firstName: firstName,
        lastName: lastName,
        email: email,
        phone: phone,
        company: form.company.value,
        role: form.role.value,
        services: selectedServices,
        message: form.message.value,
        recaptchaToken: recaptchaToken
      };

      // Send POST request to API
      const API_ENDPOINT = 'https://api.fidelidapp.cl/api/mcp/clients/add';
      const apiResponse = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-MCP-API-Key': '1000782937f7872abdc0e4fadc467bbcea6b353420aed09c29f036f3b0fa2056'
        },
        body: JSON.stringify({
          slug: 'ewaffle',
          clientData: {
            name: name,
            email: email,
            phoneNumber: phone || ''
          }
        })
      });

      // Check if API request was successful
      if (!apiResponse.ok) {
        console.warn('API request failed, but continuing with email send');
      }

      // Send email using EmailJS (in parallel)
      await emailjs.send(
        'service_d08f3xv', // Replace with your EmailJS service ID
        'template_b6dnfrh', // Replace with your EmailJS template ID
        templateParams
      );
      
      // Show success message
      alert('¡Gracias por tu mensaje! Te contactaremos pronto.');
      form.reset();
      
      // Reset reCAPTCHA
      if (typeof grecaptcha !== 'undefined') {
        grecaptcha.reset();
      }
      
    } catch (error) {
      console.error('Error:', error);
      alert('Hubo un error al enviar el formulario. Por favor, intenta nuevamente.');
      
      // Reset reCAPTCHA on error
      if (typeof grecaptcha !== 'undefined') {
        grecaptcha.reset();
      }
    } finally {
      // Reset button state
      submitButton.disabled = false;
      buttonText.textContent = originalText;
      buttonIcon.className = 'ri-send-plane-line ml-2';
    }
  });
</script>

<style>
  .container {
    max-width: 1200px;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  #recaptcha-container {
    margin: 1rem 0;
  }

  /* Ensure reCAPTCHA widget is responsive */
  .g-recaptcha {
    display: inline-block;
  }

  @media (max-width: 640px) {
    .g-recaptcha {
      transform: scale(0.85);
      transform-origin: 0 0;
    }
  }
</style> 