---
interface Props {
  courseName?: string;
  courseSlug?: string;
}

const { courseName = "nuestros cursos", courseSlug = "academia" } = Astro.props;
---

<div id="discount-popup" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-accent to-secondary p-6 text-white text-center">
      <div class="text-4xl mb-2">ðŸŽ‰</div>
      <h3 class="text-2xl font-bold mb-2">Â¡Oferta Especial!</h3>
      <p class="text-white/90">Â¿Quieres un descuento exclusivo para {courseName}?</p>
    </div>

    <!-- Content -->
    <div class="p-6">
      <!-- Email Form -->
      <div id="email-form" class="space-y-4">
        <div>
          <label for="discount-email" class="block text-sm font-medium text-gray-700 mb-2">
            Ingresa tu email para recibir tu cÃ³digo de descuento
          </label>
          <input
            type="email"
            id="discount-email"
            placeholder="tu@email.com"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent transition duration-200"
            required
          />
        </div>
        
        <button
          id="get-discount-btn"
          class="w-full bg-accent text-white py-3 rounded-lg font-semibold hover:bg-secondary/90 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Â¡Quiero mi Descuento!
        </button>
        
        <p class="text-xs text-gray-500 text-center">
          Al enviar tu email, recibirÃ¡s un cÃ³digo de descuento del 50% vÃ¡lido por 7 dÃ­as
        </p>
      </div>

      <!-- Success Animation -->
      <div id="success-animation" class="hidden text-center">
        <div class="mb-6">
          <div class="text-6xl mb-4">ðŸŽŠ</div>
          <h4 class="text-2xl font-bold text-primary mb-2">Â¡Felicidades!</h4>
          <p class="text-gray-600 mb-4">Tu cÃ³digo de descuento estÃ¡ listo</p>
        </div>

        <!-- Rolling Number Animation -->
        <div class="bg-gradient-to-r from-primary to-secondary rounded-xl p-6 mb-6">
          <div class="text-white text-center">
            <p class="text-sm mb-2">Tu cÃ³digo de descuento es:</p>
            <div id="discount-code" class="text-3xl font-bold tracking-wider">
              <span id="rolling-number" class="inline-block">0</span>%
            </div>
            <p class="text-sm mt-2 opacity-90">CÃ³digo: <span id="code-text" class="font-mono font-bold">SEP50</span></p>
          </div>
        </div>

        <!-- Copy Code Button -->
        <button
          id="copy-code-btn"
          class="w-full bg-yellow text-white py-3 rounded-lg font-semibold hover:bg-yellow/90 transition-colors duration-300 mb-4"
        >
          ðŸ“‹ Copiar CÃ³digo
        </button>

        <!-- Use Code Button -->
        <a
          id="use-code-btn"
          href="#"
          target="_blank"
          class="block w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-secondary/90 transition-colors duration-300 text-center"
        >
          ðŸ›’ Usar CÃ³digo Ahora
        </a>

        <p class="text-xs text-gray-500 mt-4">
          El cÃ³digo serÃ¡ enviado tambiÃ©n a tu email
        </p>
      </div>
    </div>

    <!-- Close Button -->
    <button
      id="close-popup"
      class="absolute top-4 right-4 text-white/70 hover:text-white transition-colors duration-200"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>
</div>

<!-- EmailJS SDK -->
<script
  type="text/javascript"
  src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"
></script>

<script>
  // @ts-ignore
  const _w = window as any;
  
  // Initialize EmailJS
  (function () {
    if (_w.emailjs) {
      _w.emailjs.init("K-nZvIRLeVaUXubMu");
    }
  })();

  // DOM Elements
  const popup = document.getElementById('discount-popup');
  const emailForm = document.getElementById('email-form');
  const successAnimation = document.getElementById('success-animation');
  const emailInput = document.getElementById('discount-email') as HTMLInputElement;
  const getDiscountBtn = document.getElementById('get-discount-btn') as HTMLButtonElement;
  const closePopup = document.getElementById('close-popup');
  const rollingNumber = document.getElementById('rolling-number');
  const codeText = document.getElementById('code-text');
  const copyCodeBtn = document.getElementById('copy-code-btn');
  const useCodeBtn = document.getElementById('use-code-btn');

  // Course information
  const courseName = '{courseName}';
  const courseSlug = '{courseSlug}';

  // Show popup function
  function showDiscountPopup() {
    if (popup) {
      popup.classList.remove('hidden');
      popup.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }
  }

  // Hide popup function
  function hideDiscountPopup() {
    if (popup) {
      popup.classList.add('hidden');
      popup.classList.remove('flex');
      document.body.style.overflow = 'auto';
    }
  }

  // Rolling number animation
  function animateRollingNumber() {
    if (!rollingNumber) return;
    
    const targetNumber = 50;
    const duration = 2000; // 2 seconds
    const startTime = Date.now();
    
    function updateNumber() {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Easing function for smooth animation
      const easeOut = 1 - Math.pow(1 - progress, 3);
      const currentNumber = Math.floor(easeOut * targetNumber);
      
      rollingNumber.textContent = currentNumber.toString();
      
      if (progress < 1) {
        requestAnimationFrame(updateNumber);
      } else {
        rollingNumber.textContent = targetNumber.toString();
      }
    }
    
    updateNumber();
  }

  // Copy code to clipboard
  function copyToClipboard(text: string) {
    navigator.clipboard.writeText(text).then(() => {
      if (copyCodeBtn) {
        const originalText = copyCodeBtn.textContent;
        copyCodeBtn.textContent = 'âœ… Â¡Copiado!';
        copyCodeBtn.classList.add('bg-green-500');
        setTimeout(() => {
          copyCodeBtn.textContent = originalText;
          copyCodeBtn.classList.remove('bg-green-500');
        }, 2000);
      }
    });
  }

  // Send email with discount code
  async function sendDiscountEmail(email: string) {
    if (!_w.emailjs) return;
    
    const templateParams = {
      to_email: 'alvaro@ewaffle.cl',
      course_name: courseName,
      course_slug: courseSlug,
      discount_code: 'SEP50',
      discount_percentage: '50%',
      message: ` "${email}" se ha registrado para recibir un cÃ³digo de descuento del 50% para el curso "${courseName}".`
    };

    try {
      await _w.emailjs.send(
        "service_d08f3xv",
        "template_b6dnfrh", // You might want to create a specific template for discount codes
        templateParams
      );
      console.log('Discount email sent successfully');
    } catch (error) {
      console.error('Error sending discount email:', error);
    }
  }

  // Event Listeners
  if (getDiscountBtn && emailInput) {
    getDiscountBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      const email = emailInput.value.trim();
      if (!email || !email.includes('@')) {
        alert('Por favor, ingresa un email vÃ¡lido');
        return;
      }

      // Disable button and show loading
      getDiscountBtn.disabled = true;
      getDiscountBtn.textContent = 'Enviando...';

      try {
        // Send email
        await sendDiscountEmail(email);
        
        // Show success animation
        emailForm?.classList.add('hidden');
        successAnimation?.classList.remove('hidden');
        
        // Start rolling animation
        setTimeout(() => {
          animateRollingNumber();
        }, 500);
        
        // Update use code button with course link
        if (useCodeBtn) {
          useCodeBtn.href = `/academia/curso/${courseSlug}`;
        }
        
      } catch (error) {
        console.error('Error:', error);
        alert('Hubo un error al procesar tu solicitud. Por favor, intenta nuevamente.');
        getDiscountBtn.disabled = false;
        getDiscountBtn.textContent = 'Â¡Quiero mi Descuento!';
      }
    });
  }

  if (copyCodeBtn) {
    copyCodeBtn.addEventListener('click', () => {
      copyToClipboard('SEP50');
    });
  }

  if (closePopup) {
    closePopup.addEventListener('click', hideDiscountPopup);
  }

  // Close popup when clicking outside
  if (popup) {
    popup.addEventListener('click', (e) => {
      if (e.target === popup) {
        hideDiscountPopup();
      }
    });
  }

  // Close popup with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && popup && !popup.classList.contains('hidden')) {
      hideDiscountPopup();
    }
  });

  // Auto-show popup after 3 seconds
  setTimeout(() => {
    showDiscountPopup();
  }, 3000);

  // Export functions for external use
  _w.showDiscountPopup = showDiscountPopup;
  _w.hideDiscountPopup = hideDiscountPopup;
</script>

<style>
  /* Custom animations */
  @keyframes bounce {
    0%, 20%, 53%, 80%, 100% {
      transform: translate3d(0,0,0);
    }
    40%, 43% {
      transform: translate3d(0, -30px, 0);
    }
    70% {
      transform: translate3d(0, -15px, 0);
    }
    90% {
      transform: translate3d(0, -4px, 0);
    }
  }

  .animate-bounce {
    animation: bounce 1s infinite;
  }

  /* Smooth transitions */
  #discount-popup {
    transition: all 0.3s ease-in-out;
  }

  #success-animation {
    transition: all 0.5s ease-in-out;
  }
</style>
